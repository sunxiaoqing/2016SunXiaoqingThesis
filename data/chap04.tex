%%% Local Variables: 
%%% mode: latex
%%% TeX-master: t
%%% End: 

\chapter{E区电离图类型识别及参数度量}
\label{cha4}

由于电离层时变、色散等特殊性，并受太阳活动和地磁活动等因素的影响，电离图情况复杂多变\cite{柳文2009基于}，同时Es层的主要特点是出现没有规律性，种类多并且描迹还存在不同程度的扩散。至今仍没有一个完善的方法适应复杂多变的E区电离图，E区电离图的自动判读研究仍然有重要的意义。目前存在的Es层描迹类型识别方法中，仅仅针对常见的Es类型，如$c$型、$l$型、$f$型、$h$型进行识别。本文的E区电离图类型识别与参数度量算法中，涉及了多种Es类型识别，即包括扩散型Es层描迹，也包括非扩散型Es层描迹。
        
人工对电离图E区描迹进行判读的步骤如下：找到描迹、提取描迹特征、识别描迹类型及获取参数度量值。我们借鉴人工度量经验，运用图像处理知识设计E区电离图类型识别与参数度量算法主要包括：垂测电离图E区描迹检测、基于扩散程度的描迹区域分类、E区电离图分类、描迹分割、去除Es层多次反射、描迹特征提取、描迹类型识别与度量。

%=============================================================================================================
\section{垂测电离图E区描迹检测}
\label{4_1}

E区描迹经常会存在着不同程度的扩散现象，同时在电离图上还存在着各种原因引起的噪声（如图~\ref{图4_1}(a)）。如果直接对电离图进行去噪处理, 会导致描迹信息的丢失。通过对电离图进行观察，可以发现构成描迹的区域都是电离图上非零信号点（灰度值非零的像素点）分布比较密集的区域，于是本文提出了基于密集点查找的候选描迹区域自动检测算法。

%-------------------------------------------------------------------------------------------------------------
\subsection{候选描迹区域检测}
\label{4_1_1}

首先，查找密集点。利用积分图法（Summed area table）\cite{crow1984summed}在电离图上找到有值信号点比较密集的像素点，如图~\ref{图4_1}(b)所示，电离图上可以构成描迹的像素点之间相邻或距离较近，而噪声像素点比较离散，通过对构成描迹像素点的特征进行观察与总结，本文选择使用2×2和3×1窗口来遍历整幅电离图，找到所有满足2×2和3×1窗口全部有值的小区域，并把区域内的点标记为密集点保留（图~\ref{图4_1}(c)）。运用积分图法可以快速的定位电离图上的密集点。积分图法介绍如下：

\begin{figure}[!ht]
\centering
\includegraphics[width=0.8\textwidth]{图4_1}
\caption{检测候选描迹区域}
\label{图4_1}
\end{figure} 

图像矩阵为$i(x,y)$，积分图的任意一点$(x,y)$表示原图像矩阵上图像原点与该点构成的矩型小区域内所有像素点灰度值的总和，即
\begin{linenomath}
\begin{align}
I(x,y)=\sum_{\substack{x^{'}<x\\y^{'}<y}}i(x^{'},y^{'})
\label{式4_1}
\end{align}
\end{linenomath}

其中$I(x,y)$表示积分图像。$I(x,y)$可用下式表示：
\begin{linenomath}
\begin{align}
I(x,y)=i(x,y)+I(x-1,y)+I(x,y-1)-I(x-1,y-1)
\label{式4_2}
\end{align}
\end{linenomath}

          
将原图像的像素值代入上式就计算积分表，利用积分表，我们就可计算出原图像上任意一个矩阵区域的积分值。如图~\ref{图4_2}，图像区域ABCD的四个端点的坐标为A=(x0, y0)，B=(x1, y0)，C=(x0, y1)，D=(x1, y1)，那么:
\begin{linenomath}
\begin{align}
\sum_{\substack{x_{0}<x\le x_{1} \\y_{0}<y\le y_{1}}}i(x,y)=I(D)+I(A)-I(B)-I(C)
\label{式4_3}
\end{align}
\end{linenomath}

\begin{figure}[!ht]
\centering
\includegraphics[width=0.3\textwidth]{图4_2.png}
\caption{积分图}
\label{图4_2}
\end{figure} 
	        
  
为了便于密集点的查找，将原始灰度电离图转换为二值电离图。原始电离图的灰度值函数为$i(x,y)$，对于图像图像上的任意点$(x,y)$，如果$i(x,y)>0$ ，就令$i(x,y)=1$。根据二值电离图$i(x,y)$建立对应的积分表$I(x,y)$，运用积分图法依次用2×2和3×1窗口遍历整个电离图，并对小区域内值全为1的点进行标记，这些点被标记为密集点。如图~\ref{图4_1}(c)为密集点集的查找结果。
              
其次，确定包含密集点的连通区域。密集点集代表E区描迹的主要信息，为了确定包含描迹的闭合区域，对密集点集进行图像形态学闭运算操作，可以得到闭合的候选描迹区域。为了确定候选描迹区域的个数，对闭操作后的电离图进行连通区域检测（图~\ref{图4_1}(d)）。

	


         
数学形态学可以作为数字图像处理与分析的基础，它可以用于简化图像的复杂度、提取图像的主要信息、去除图像上的不相干结构。数字形态学主要有4种运算：膨胀、腐蚀、开、闭运算。 设集合A、B是$Z^{2}$中的两个子集，

膨胀：A被B膨胀定义为： 
\begin{linenomath}
\begin{align}
 A \oplus B=\{z | {(\widehat{B})}_{z} \cap A \neq  \varnothing \}；
\label{式4_4}
\end{align}
\end{linenomath}

A被B膨胀是所有位移$z$的集合，$\widehat{B}$和A至少有一个元素是重叠的。公式也可写为：
\begin{linenomath}
\begin{align}
A \oplus B=\{z | {[(\widehat{B})}_{z} \cap A]  \subseteq  A \}；
\label{式4_5}
\end{align}
\end{linenomath}   
       
腐蚀：使用B对A进行腐蚀，用$A\ominus B$表示，并定义为：
\begin{linenomath}
\begin{align}
A \ominus B=\{z | {(\widehat{B})}_{z}  \subseteq  A \}；
\label{式4_6}
\end{align}
\end{linenomath}

使用B对A进行腐蚀就是所有B对A中的点$z$的集合用$z$平移。
        
上面介绍了数字形态学的膨胀和腐蚀运算。膨胀可以扩散图像轮廓、修复断裂，而腐蚀可以消除不相关的细节。对图像进行膨胀操作可以使图像上被操作区域变大，而对图像进行腐蚀操作会使图像上的被操作区域变小。除了膨胀、腐蚀操作，形态学的基本操作还有开操作和闭操作。对图像进行开操作可以使目标的边界变得更加光滑，可以消除边界上的毛刺和突出物。对图像进行闭操作，会弥补图像上物体的间断和细长的鸿沟，同时可以填补图像上小的孔洞。
                
开运算：用结构元素B对集合A进行开操作，表示为$A \circ B$，定义为:
\begin{linenomath}
\begin{align}
 A \circ B=(A \ominus B) \oplus B；
\label{式4_7}
\end{align}
\end{linenomath}

         
闭运算：用结构元素B对集合A进行闭操作，表示为$A \cdot B$，定义为：
\begin{linenomath}
\begin{align}
A \cdot B=(A \oplus B)  \ominus B；
\label{式4_8}
\end{align}
\end{linenomath}
           
如图~\ref{图4_1}(d)为电离图E区检测到的密集点（如图~\ref{图4_1}(c)所示）经过闭运算后的结果。对闭运算后的电离图进行连通区域标记，及连通区域边界的查找。下面介绍连通区域标记算法：

连通分量标记法 \cite{di1999simple}可以对图像上不连续的有值像素区域进行标记，并用不同的数字依次递增表示，使图像操作更有目标性。在电离图E区描迹区域查找中，利用连通区域标记法可以为我们确定候选描迹区域的个数。常见的连通区域标记法有四连通区域和八连通区域。四连通区域是指$(x,y)$像素位置的四个领域位置$(x-1,y)$、$(x+1,y)$、$(x,y-1)$、$(x,y+1)$，称为四连通区域（四领域）。八连通是指对应像素位置的上、下、左、右、左上、右上、左下、右下，称之为8连通区域（八邻域），八领域也可定义为如式~\ref{式4_10}。 某点的八连通区域是指该点的四连通区域加上该点右下位置、右上位置、左下位置、左上位置。如图~\ref{图4_3}为四连通区域标记结果。
\begin{linenomath}
\begin{align}
 N8(p)=N4\cup (x+1,y+1),(x+1,y-1),(x-1,y+1),(x-1,y-1)
\label{式4_10}
\end{align}
\end{linenomath}
 
\begin{figure}[!ht]
\centering
\includegraphics[width=0.6\textwidth]{图4_3.png}
\caption{四连通区域标记}
\label{图4_3}
\end{figure} 	 
 
在本文中运用八邻域标记法对闭运算后的电离图进行连通区域标记，得到如图~\ref{图4_1}(d)所示的结果。
                       
然后，排除小面积连通区域。在上一步的连通区域查找结果中，存在多个连通区域，有的连通区域面积较小，无法构成描迹。根据统计和经验，设定13作为连通区域面积的阈值对非描迹区域进行排除，得到候选描迹区域（图~\ref{图4_1}(e)）。

最后，标记候选描迹区域位置。利用连通区域标记和边界查找方法，确定候选描迹区域的闭合边界并在原电离图上标记候选描迹区域的位置。如图~\ref{图4_1}(f)所示，在原电离图上确定了4个闭合的候选描迹区域。候选描迹区域的闭合边界有利于我们对区域内的描迹进一步分析。
 
\subsection{非描迹区域排除}
\label{4_1_2}
检测到的候选描迹区域中仍存在非描迹区域（如图~\ref{图4_1}(f)所示），因此需要对候选描迹区域进一步分析并对非描迹区域进行排除。对于电离图上的有值信号点，我们并不能根据信号点值的大小来判断该信号点是否属于描迹。在本文中，对大量电离图的人工度量结果进行观察，将人眼感受到的用于判断候选描迹区域是否为描迹区域的视觉特征转换为在图像上可以量化的特征。通过对大量电离图进行实验，我们总结出以下几种特征及他们用于区分描迹区域和非描迹区域时的阈值。

定义一个代表候选描迹区域内像素点灰度信息的集合$S$，$S=\{(x,y,f(x,y))\}$，其中$x$、$y$、$f(x,y)$分别为候选描迹区域内一个像素点的横坐标、纵坐标、灰度值。定义集合$S1$为：
\begin{linenomath}
\begin{align}
 S1=\{ {(x,y,f(x,y))}\subset S: f(x,y)>0 \}
\label{式4_11}
\end{align}
\end{linenomath}
 
 
为了对候选描迹区域的特征进行描述，本文定义以下概念：
\begin{enumerate}  
 
\item区域的像素密度（${\rho}_{area}$）：区域内像素值非零的像素点与区域面积的比值，如式~\ref{式4_12}所示。
\begin{linenomath}
\begin{align}
 {\rho}_{area}=card(S1)/card(S)
\label{式4_12}
\end{align}
\end{linenomath}

\item区域所在的位置（$x_{max}$和$y_{max}$）：根据对大量电离图进行观察与统计，如果描迹区域满足式~\ref{式4_13}和~\ref{式4_14}，认为该描迹区域为目前没有合理解释的非描迹区域。
\begin{linenomath}
\begin{align}
 h_{step}*(m-x_{max}) \leq 95
\label{式4_13}
\end{align}
\end{linenomath}
\begin{linenomath}
\begin{align}
 f_{0}+y_{max}*f_{step}\leq f_{0}+15f_{step}
\label{式4_14}
\end{align}
\end{linenomath}

\item区域的长度（$l_{area}$）：描迹区域横坐标的右端最大值减去描迹区域的左端最小值。
\begin{linenomath}
\begin{align}
  l_{area}=max⁡(y)-min⁡(y)
\label{式4_15}
\end{align}
\end{linenomath}



\item区域内非零像素个数（$N_{nonzero}$）:区域内非零像素点（有值信号点的个数）。
\begin{linenomath}
\begin{align}
  N_{nonzero}=card(S1)
\label{式4_16}
\end{align}
\end{linenomath}

\end{enumerate}  
  
基于上述特征设计的非描迹区域排除算法的步骤如下：

\begin{enumerate}  
  
\item如果候选描迹区域的个数为零，电离图E区无描迹。
  
\item如果$N_{nonzero}<13$，此区域为非描迹区域。
 
\item如果候选描迹区域的位置位于目前没有合理解释的无效位置，此区域为非描迹区域。
 
\item如果${\rho}_{area}<0.5$，此区域为非描迹区域。

\item如果$l_{area}<3$，此区域内为垂线噪声即非描迹区域。
\end{enumerate}  

如图~\ref{图4_4}所示，根据上述非描迹区域排除算法，可知序号为1、3、4的候选描迹区域为非描迹区域，而序号为2的候选描迹区域为描迹区域，排除非描迹区域后便得到仅包含描迹区域的干净电离图。

\begin{figure}[!ht]
\centering
\includegraphics[width=0.5\textwidth]{图4_4.png}
\caption{非描迹区域排除结果}
\label{图4_4}
\end{figure} 	
%=============================================================================================================
\section{基于扩散程度的描迹区域分类}
\label{4_2}

E区最大的特点就是描迹类型的多样性（包括E层、E2层、$l$型、$f$型、$c$型、$h$型、$r$型、$k$型、$n$型、$a$型、$s$型、$q$型描迹）。在人对于描迹类型的判别过程中，首先，根据描迹的扩散特点将描迹分为两大类：$a$型、$q$型、$s$型描迹；E层、E2层、$l$型、$f$型、$c$型、$h$型、$r$型、$k$型、$n$型描迹。然后，再根据每类描迹的特点进行特征提取与描迹类型识别。

在本文自动度量算法中，在对描迹进行特征提取与类型识别之前，先根据描迹区域的扩散程度对描迹区域进行分类。在本章中，为了评价一个区域内描迹的扩散程度，提出扩散密度的概念。根据描迹区域的扩散程度及其它特征将描迹区域分为三类：第一类：描迹区域内的描迹为直线型、上升型、下降型（E层、E2层、$l$型、$f$型、$c$型、$h$型、$r$型、$k$型、$n$型）；第二类：描迹区域内的描迹为$a$型、$q$型、$s$型；第三类：描迹区域内的描迹为直线型描迹与$s$型描迹混合的情况。

通过对扩散型描迹区域和非扩散型描迹区域进行观察与总结，本文提出扩散密度（$\rho_{spread}$）的概念及其求法，用一个2*2掩膜在描迹区域内遍历，如果描迹在掩膜区域矩阵内只有在2个有像素值的点，我们就把这样的点标记为扩散点。运用积分图法可以确定电离图上的扩散点个数及所有非零像素点个数。$\rho_{spread}$就等于扩散点的个数与描迹区域内所有非零像素点个数之比。如图~\ref{图4_5}所示，通过对比不同扩散密度对应的电离图可知，$\rho_{spread}$值越大，满足条件的离散点越多，描迹的扩散程度越大。

\begin{figure}[!ht]
\centering
\includegraphics[width=0.8\textwidth]{图4_5}
\caption{扩散密度对比}
\label{图4_5}
\end{figure} 

通过对描迹区域进行观察、实验和分析，我们总结出以下特征用来对描迹区域的扩散程度进行分类：像素密度（$\rho_{area}$）、区域扩散密度（$\rho_{spread}$）、区域最大行密度（$max(\rho_{row})$）、区域平均列高度（$W_{col}$）以及区域内非零像素个数（$N_{nonzero}$）。

\begin{enumerate}  
\item$\rho_{area}$ :与4.1节中所介绍的含义相同，这里就不在赘述。

\item$max(\rho_{row})$:等于区域所有行密度中的最大值。行密度（$\rho_{row}$）:描迹区域每行中非零值的总数与描迹区域非零列总数的比值。

\item$W_{col}$:区域中非零像素点个数比上区域列数。

\item$N_{nonzero}$: 与4.1节中所介绍的含义相同，这里就不在赘述。

\end{enumerate}  

正确的对描迹区域根据扩散程度进行分类，有利于对不同扩散程度和不同类型的电离图进一步分类。具体算法步骤如下：

\begin{enumerate} 
\item如果$\rho_{area}> 0.8$或$\rho_{spread} <0.6$，描迹属于第一类描迹。

\item对区域长度大于 100 个像素同时区域宽度大于 30 个像素的描迹区域基于区域行中线和区域列中线将区域分成 4 块，并计算每块的$\rho_{area}$和$\rho_{spread}$。如果 在 4 块小区域中存在一块区域的$\rho_{area}<0.1$ ，同时存在一块$\rho_{area}>0.1$同时 $\rho_{spread}>0.8$，描迹属于第三类描迹。

\item如果区域$W_{area}<15$、$max(\rho_{row})>0.8$或$W_{col}<8$，描迹为第一类描迹。如果不满足条件，描迹为第二类描迹。
\end{enumerate}
%=============================================================================================================
\section{E区电离图分类}
\label{4_3}

我们对每个描迹区域进行分类后,再根据 E 区电离图上所有描迹区域的信息对 E 区电离图进行分类。为了方便描迹自动度量算法的设计，将E区电离图分为以下五类：第一类，无描迹E区电离图；第二类，常规E区电离图(E层、 E2层、$l$型、$f$型、$c$型、 $h$型、$r$型、$k$型、$n$型)；第三类，扩散型E区电离图(Es层$a$型、$q$型、$s$型)；第四类：直线型与$s$型描迹混合的情况；第五类：复杂描迹E区电离图。E区电离图分类算法如下:

\begin{enumerate} 
\item E区电离图上描迹区域个数为0，电离图属于第一类(无描迹 E 区电离图)。

\item 如果E区电离图上的所有描迹区域都属于第一种描迹区域，那么电离图就属于第二类E区电离图；如果E区电离图上的所有描迹区域都属于第二种描迹区域，那么电离图属于第三类电离图；如果E区电离图上的描迹区域只有一个且属于第三种描迹区域，那么E区电离图属于第四类电离图；如果E区电离图属于同时包含两种以上的描迹区域，那么电离图属于第五类电离图(特殊电离图)。
\end{enumerate} 

对于第一类无描迹E区电离图，我们可以直接得到Ｅ区参数的度量结果；对于第五类电离图，由于描迹情况比较复杂，在算法中对复杂电离图进行标记，进行人工度量；对于剩余三类电离图，根据电离图上的描迹分布特点，设计了不同的描迹分割及特征提取算法。

有效的进行电离图分类，并确定无描迹E区电离图和复杂非常规E区电离图，可以有效的提高算法正确率并简化后期算法。对于不同特征的电离图，本文设计了不同的描迹分割、描迹特征提取及判读方法。

%=============================================================================================================
\section{描迹分割}
\label{4_4}

E区经常出现E层描迹和Es层描迹相连或两个Es层描迹之间距离很近的情况，这样会导致在候选描迹区域查找结果中存在不同层描迹信息被划分到同一个描迹区域内。所以，先要对区域内的描迹进行分割，并把每个描迹单独的提取出来。本文根据描迹的特点针对不同类型的电离图，设计不同的描迹分割方法。 对于第三类扩散性E区电离图无需进行描迹分割，对第二类与第四类电离图进行描迹分割，具体算法介绍如下。

\subsection{第二类E区电离图描迹分割}
\label{4_4_1}

第二类电离图为常规型电离图，包括E 层、 E2 层、$l$ 型、$f$型、$c$型、 $h$型、$r$型、$k$型、$n$型描迹，在电离图上的一个描迹区域内，经常出现两个描迹或多个描迹。为了对描迹进行精确的类型识别和度量，需要先对描迹进行分割。通过对大量电离图数据的观察，总结出对于常规型描迹分割主要有以下三个步骤：基于虚高的描迹一次分割、基于最高点的描迹二次分割、基于OX波分离的描迹三次分割。 分割算法如图~\ref{图4_6}所示。

\begin{figure}[!ht]
\centering
\includegraphics[width=0.7\textwidth]{图4_6.png}
\caption{描迹分割算法流程图}
\label{图4_6}
\end{figure}


1. 基于虚高的描迹一次分割

基于虚高的描迹一次分割主要对E区描迹区域内出现两个在虚高方向上不存在任何交集的描迹进行分割（如图~\ref{图4_7}所示）。对于经过预处理后的描迹区域，利用在E区F区分割算法中提到的水平积分投影法确定描迹区域内的零区。检测到的零区有两种可能：一种是描迹的间断，另一种是两个在虚高上无交集的描迹之间的间隙。通过对零区上下两个描迹区域的三种特征（$N_{nonzero}$、最大行密度$max(\rho_{row}$)（行密度：描迹区域每行中非零值的总数与描迹区域非零列总数的比值）、${{h^{'}}_{HPV}}_{max}$）来判断描迹区域是否需要基于虚高进行分割：如果零区上（top）下（bot）描迹区域同时满足下面的条件：
\begin{linenomath}
\begin{align}
N_{nonzero}(top)>10    \quad  and \quad N_{nonzero}(bot)>10
\label{式4_17}
\end{align}
\end{linenomath}
\begin{linenomath}
\begin{align}
max(\rho_{row})(top)>0.5  \quad and \quad max(\rho_{row})(bot)>0.5 
\label{式4_18}
\end{align}
\end{linenomath}
\begin{linenomath}
\begin{align}
{{h^{'}}_{HPV}}_{max}(top)>5   \quad and \quad {{h^{'}}_{HPV}}_{max}(bot)>5   
\label{式4_19}
\end{align}
\end{linenomath}
认为描迹需要基于虚高进行分割；如果不满足则认为零区属于描迹间断故不需要基于虚高进行分割。对于需要划分的描迹区域，将零区的中线作为两个描迹的分割线。如图~\ref{图4_7}所示为基于虚高的描迹一次分割过程及结果。
\begin{figure}[!ht]
\centering
\includegraphics[width=0.6\textwidth]{图4_7.png}
\caption{基于虚高的描迹一次分割结果}
\label{图4_7}
\end{figure}

2.基于最高点的描迹二次分割

一次分割后的描迹可能会存在直线型和非直线型两种类型，非直线型描迹多数为E层与Es层$c$型、E层与Es层$h$型描迹同时存在等情况，对于这些描迹需要基于最高点再进行二次分割。

首先，需要进行直线型描迹判识：若检测到直线型描迹，则描迹分割结束；否则对其进行基于最高点的描迹二次分割。直线型描迹主要从以下两个步骤进行判识：


第一，基于图像处理对描迹区域进行形态学预处理、骨架化、曲线拟合和多项式求导实现直线型描迹初步判识。

对区域的描迹进行形态学闭运算可以使描迹轮廓更为光滑、修复描迹的断裂，并保持描迹原型。所以对描迹进行适当的形态学处理，有助于优化骨架化结果。

图像的骨架化结构能够减少图像的冗余信息，因此广泛用于图像处理的各个领域。对形态学处理后的描迹进行骨架化能够得到一个像素宽的骨架化结果。

Blum最早提出图像用骨架描述其结构的方法，它分别提出了烧草模型和最大内切圆盘\cite{blura1973biological}概念来定义图像骨架（如图~\ref{图4_8}）。在他提出的骨架化方法中运用了中轴的概念：在$t=0$时，点燃图像边缘上的所有点，图像边界上的点以相同的速度向图像内部燃烧，当边界上不同的两个点发出的波相遇时，火焰就熄灭，火焰相遇的点构成的集合叫作中轴。同时我们还可以利用中轴函数（从点燃烧到x点所经历的时间t之间的函数关系）对图像进行重建。

\begin{figure}[!ht]
\centering
\includegraphics[width=0.7\textwidth]{图4_8.png}
\caption{两种骨架化模型}
\label{图4_8}
\end{figure}


对电离图进行骨架化操作时，希望能够保留较完整的描迹信息，能够通过骨架化结果判读出描迹的形状，同时可以通过对骨架化结果进行操作来还原描迹。常见的骨架化算法有基于拓扑细化的、基于形态学操作的、基于距离变化的\cite{廖志武20092}\cite{陈晓飞2004基于骨架的目标表示和识别技术研究}。 在本文中运用基于形态学操作的骨架化提取算法。

在基于形态学操作的骨架化提取算法中运用了击中或击不中变换算法。形态学中的击中或击不中变换算法是形状检测的基本工具。在本文第三章已经介绍过数字形态学的基本概念，下面介绍击中或击不中算法。A为待处理图像，B为满足下式的结构元素对，且B由B1和B2构成。
\begin{linenomath}
\begin{align}
\left \{
\begin{aligned}
B=B1 \cup B2\\
B1 \cap B2=\varnothing
\end{aligned} 
\right.
\label{式4_20}
\end{align}
\end{linenomath}

$B\{B1,B2\}$对A的击中或击不中变换$(HMT)$定义如下式：
\begin{linenomath}
\begin{align}
 {HMT}_{B}(A)=(A \ominus B_{1})\cap(A^{c} \ominus B_{2})
\label{式4_21}
\end{align}
\end{linenomath}

通过上式可知击中或击不中变换的结果同时包含了所有原点，$B_{1}$在A内找到匹配，同时$B_{2}$在$A^{c}$(A的补集)找到匹配。找到图像中与结构元素相匹配的所有像素点。运用击中或击不中变换对描迹进行骨架化方法的定义如下：
\begin{linenomath}
\begin{align}
A \otimes B =A-{HMT}_{B}(A)
\label{式4_22}
\end{align}
\end{linenomath}
 
结构元素对图像的细化有重要影响，在应用中用若干个结构元素对序列${B}={B^{1}, B^{2},...,B^{n}}$进行击中或击不中变换，如下式所示：
\begin{linenomath}
\begin{align}
A \otimes {B}=((...((A \otimes B^{1})\otimes B^{2})...) \otimes {B^{n}})
\label{式4_23}
\end{align}
\end{linenomath} 
  
公式~\ref{式4_23}表明，我们依次用结构元素对前一次的操作结果，继续进行细化，当骨架化结果不在改变时，可以停止细化过程。如图~\ref{图4_9}为常见的结构元素。
 
\begin{figure}[!ht]
\centering
\includegraphics[width=0.7\textwidth]{图4_9.png}
\caption{多方向细化结构元素对}
\label{图4_9}
\end{figure}

本文利用基于形态学操作的骨架化提取算法对描迹进行骨架化，得到单像素的骨架化结果。为确定的描迹的形状，我们对描迹的骨架化结果进行多项式曲线拟合。多项式拟合的定义如下：假设给定数据点$(x_{i},y_{i})$，$(i=0,1,...,m)$，$\phi$为次数小于$n$ $(n<m)$的多项式构成的函数类，找到$p_{n}(x)={\sum}_{k=0}^{n}a_{k}x^{k}\subset \phi$，使得
\begin{linenomath}
\begin{align}
I={\sum}_{k=0}^{m}[p_{n}(x_{i})-y_{i}]^{2}={\sum}_{i=0}^{m}{({\sum}_{k=0}^{n}a_{k}{x_{i}}^{k}-y_{i})}^{2}=min
\label{式4_24}
\end{align}
\end{linenomath} 

 当函数为多项式时，同时满足式~\ref{式4_24}称为最小二乘拟合多项式。通过大量实验验证，在本文中我们对描迹的骨架化结果进行4次多项式拟合。如果多项式次数太低会出现拟合曲线与用来拟合的描迹点之间存在较大的差值，反之如果选择的多项式次数太高拟合出来的曲线存在多个拐点，影响描迹形状的判断。
 
为了判断曲线拟合后描迹的形状，对拟合多项式进行求导。如图~\ref{图4_10}为不同形状描迹的曲线拟合与求导结果，观察可以发现直线型描迹的求导结果在零值附近，基于该特征对直线型描迹进行初步判识；对于存在着断裂等现象的直线型描迹，因骨架化拟合效果不好，未检测出其为直线，则需要进一步判识。
 
\begin{figure}[!ht]
\centering
\includegraphics[width=0.5\textwidth]{图4_10.png}
\caption{不同描迹形状的曲线拟合与求导结果}
\label{图4_10}
\end{figure}

 
第二，利用像素分布特征对可能存在断裂的直线型描迹进行进一步判识。我们采用的像素分布特征主要包括描迹的最大宽度（$W_{max}$）和$\rho_{row}$：直线型相对于其他型描迹宽度较小且最大行密度$max(\rho_{row})$接近于1。

通过以上两步，可以检测出描迹是否为直线型描迹，如果是直线型描迹，描迹细分结束；如果是非直线型描迹，基于最高点进行描迹的二次分割。

然后，对于非直线型描迹，进行基于最高点的描迹二次分割：查找描迹区域内的最高点，如果存在多个相同高度的最高点，就利用$foE$的经验值选择最高点；再对最高点左右两侧的总像素个数进行统计，如果最高点左右非零信号点个数都大于20，认为最高点左右两侧都有描迹，进而将描迹划分为左侧描迹和右侧描迹。图~\ref{图4_11}为基于最高点的描迹分割结果。

\begin{figure}[!ht]
\centering
\includegraphics[width=0.6\textwidth]{图4_11.png}
\caption{基于最高点的描迹细分结果}
\label{图4_11}
\end{figure}

3.基于OX波分离的描迹三次分割

对二次分割结果的单侧描迹的$N_{nonzero}$进行统计，如果$N_{nonzero}<50$，认为描迹短小且不存在OX分离的情况，此类描迹可用端点位置分析法进行描迹类型识别与度量；对于$N_{nonzero}\geq 50$的描迹进行基于OX波分离的描迹三次分割：

首先，骨架化与连通区域查找。对单侧描迹的骨架化结果进行连通区域查找（图~\ref{图4_12}(a1)与(b1)），如果只有一个连通区域，无需进行OX波分离；如果存在大于一个连通区域的描迹，标记每个连通区域的左端最高点和右端最高点，我们把标记值为i的连通区域的左端最低点、右端最高点、右端最低点在电离图上的坐标用$(x_{l\_Low} (i) \quad y_{l\_Low} (i))$、$(x_{r\_Hight} (i) \quad y_{r\_Hight} (i) )$和$(x_{r\_Low} (i) \quad y_{r\_Low} (i) )$表示。

\begin{figure}[h]
%\begin{figure}[!ht]
\centering
\includegraphics[width=0.5\textwidth]{图4_12.png}
\caption{基于OX波分离的描迹三次分割结果}
\label{图4_12}
\end{figure}

其次，连通区域选择性合并。OX波分离时O波与X波描迹具有以下特征：O波与X波的虚高相差很小；O波与X波描迹形状相同；O波与X波描迹的最大频率相差半个磁旋频率（0.7MHz左右）（如图~\ref{图4_12}(b1)）。对于连通区域个数大于1个的描迹，本文利用OX分离时描迹的这些特征，设计连通区域选择性合并算法如下：
 
第一，对于标记值为p的连通区域，从标记值大于p的连通区域中查找距其最近的连通区域（其标记值为q）。

第二，判断这两个连通区域是否满足以下条件：左侧描迹条件$0.6MHz<f_{step} [y_{r\_Low}(p)-y_{r\_Low}(q)]<0.8MHz$且$|x_{r\_Low} (p)-x_{r\_Low} (q)|\leq3$；右侧描迹条件为$0.6MHz<f_{step} [y_{r\_Low}(p)-y_{r\_Low} (q)]<0.8MHz$且$|x_{r\_Low} (p)-x_{r\_Low} (q)|\leq3$。如果不能满足以上条件，说明两个描迹连通区域非OX波分离的情况，对连通区域进行合并，即将标记值为p的连通区域重新标记为q（图~\ref{图4_12}(a2)）；否则，不进行合并（图~\ref{图4_12}(b2)）。
 
第三，按照上述步骤依次遍历每个连通区域。

最后，根据骨架化后的连通区域选择性合并结果进行基于OX波分离的描迹三次分割。骨架化结果经连通区域选择性合并后，如果连通区域的个数为1，描迹为非OX波分离情况无需分割（图~\ref{图4_12}(a3)）；如果连通区域的个数为2，对描迹进行基于OX波分离的描迹三次分割（图~\ref{图4_12}(b3)）；如果连通区域的个数大于2，将连通区域中面积较小的连通区域作为描迹的毛刺去掉，只保留连通区域面积最大和次大的连通区域并进行分割。



\subsection{第四类E区电离图描迹分割}

第四类E区电离图是指E区只包含直线型与$s$型描迹混合情况时的电离图，对于这类电离图我们应把直线型描迹和s型描迹分开。

利用直线型描迹与$s$型描迹特征的区别，提出了直线型与$s$型描迹分割算法主要包括以下步骤:

由图~\ref{图4_13}(a)可知直线型描迹与$s$型描迹的扩散程度不同，因此将描迹区域单独放在一个矩阵中，按照矩阵的行中线和列中线将描迹分为四块，然后将四块描迹区域中$\rho_{area} < 0.1$的描迹区域内像素值非零的点赋值为 0；

\begin{figure}[!ht]
\centering
\includegraphics[width=0.5\textwidth]{图4_13}
\caption{第四类E区电离图描迹分割结果}
\label{图4_13}
\end{figure}

确定描迹区域每个非零行中从左到右第一个非零值所在的列值$col(i)$，从第一行开始比较第$i$行与第$i + 1$行是否满足$|col(i + 1)-col(i)| < 1/2max(col)$，如果满足继续比较，直到不满足条件停止；不满足条件时，对应的行值$i$就是$s$型描迹与直线型描迹的分割线；如图~\ref{图4_13}为第四类 E 区电离图描迹分割图例。



%=============================================================================================================
\section{去除Es层多次反射}
\label{4_5}
 
通过4.4节对描迹区域进行分割后，电离图E区上每个描迹区域内只存在一个描迹，并可以确定描迹区域的位置。对分割后的描迹去处多次Es层反射。

去除 Es 层多次反射，对于 F 区描迹度量具有重要意义。本文去除 Es 多次反射主要根据 Es描迹多次反射形成原理。反射回波描迹的虚高与一次回波描迹的虚高成倍数关系。即Es二次反射描迹的最低虚高应为Es层描迹最低虚高的二倍，Es层三次反射描迹的最低虚高应为Es层描迹虚高的三倍，更高次回波描迹可以依次类推。Es 层多次反射的具体算法如下:

首先，电离图经过 E 区 F 区分割得到 E 区电离图和 F 区电离图。对于F区电离图，用E区描迹查找方法对F区电离图进行候选描迹区域查找、非描迹区域排除，得到了只包含有效描迹的 F 区电离图。

其次，通过描迹分割，可以确定电离图 E 区共有多少个描迹以及每个描迹的 最低高度、最高高度、最小频率、最大频率。如图~\ref{图4_14}所示，可以把描迹确定在电离图上的一个小的矩阵区域内。

\begin{figure}[!ht]
\centering
\includegraphics[width=0.9\textwidth]{图4_14}
\caption{查找Es层描迹的多次反射}
\label{图4_14}
\end{figure}

然后，利用描迹的最低高度与其反射描迹的最低高度的倍数关系，我们就可以在F区电离图上确定多个候选反射区域的位置。

最后，对比候选反射区域内描迹的像素个数与原描迹像素个数的关系，排除无效的候选反射区域，只保留有效的反射区域。 图~\ref{图4_14}为 Es 层多次反射查找结果。


%=============================================================================================================
\section{描迹特征提取}
\label{4_5}


对大量电离图进行人工度量发现，人工对描迹类型的识别主要根据描迹形状(上升型、下降型、直线型)、扩散程度、描迹宽度、描迹的虚高、电离图采集 时间、描迹的最大频率、描迹最小频率等特征。在本文中利用图像处理和图像分析知识对描迹特征进行自动提取，同时基于人工度量知识，对描迹进行类型识别与参数判读。

\subsection{第二类E区电离图描迹特征提取}

通过对描迹区域内的描迹进行分割，就可以把分割后的每个描迹单独提取出来。经过对人工度量过程总结发现，描迹的形状、虚高、最大频率、最小频率以及电离图的采集时间都是判断E区描迹类型的重要依据。为了对描迹类型进行识别，我们对描迹的形状、虚高、频率特征进行自动提取。由于E区描迹的多样性，本文设计了不同的描迹特征提取方法：对于经过基于OX波分离描迹三次分割后输出为骨架化形式的描迹，采用描迹曲线拟合法来提取描迹特征；对于总像素值 比较少的短小型描迹和直线型描迹，利用端点位置分析法来提取描迹特征。

a) 描迹曲线拟合法

提取描迹形状特征:描迹曲线拟合时如果选择的多项式次数太低会导致拟合结果与实际曲线之间有很大的误差；如果选择的多项式次数太高，会导致拟合的曲线波动较大，影响求导结果。通过大量实验验证，多项式次数为4时效果最佳，所以本文选择对骨架化结果进行4次多项式拟合。为了确定描迹形状，对拟合多项式进行求导，进而确定描迹形状为上升型或下降型。

提取描迹的虚高和频率特征：如果直接对骨架化描迹进行度量，度量结果存在很大的误差。因此先对骨架化结果利用形态学操作进行描迹还原，然后对还原描迹进行度量。定义一个代表还原描迹区域在电离图上坐标的集合$S$，$S = {(x, y)}$，其中$x$、$y$分别为描迹区域内一个像素点的横坐标、纵坐标。利用下述公式分别计算描迹的最小频率$f_{min}$、最大频率$f_{max}$、描迹虚高${h^{'}}_{min}$。

\begin{linenomath}
\begin{align}
f_{min} = f_{0} + min(y)*f_{step}
\label{式4_25}
\end{align}
\end{linenomath}
\begin{linenomath}
\begin{align}
f_{max} = f_{0} + max(y)*f_{step}
\label{式4_26}
\end{align}
\end{linenomath}
\begin{linenomath}
\begin{align}
{h^{'}}_{min} = h_{step}*(m-max(x))
\label{式4_27}
\end{align}
\end{linenomath}


b) 端点位置分析法

在检测到的直线型描迹中混有一些描迹形状不明显的上升型、下降型、中间凸起型描迹，需要进行二次判识与度量；另外，在基于最高点的描迹二次分割中产生了$N_{nonzero}<50$的短小型描迹。对于这两类描迹利用描迹曲线拟合法，很难得到理想的效果。于是本文依据描迹的像素分布特点提出了端点位置分析法来提取描迹特征。

提取描迹形状特征：端点位置分析法主要利用描迹的左端最高点、右端最高点及描迹最高点之间的关系，来确定描迹形状。描迹的左端最高点、右端最高点及描迹最高点在电离图上的坐标分别为$(x_{l}, y_{l})$、$(x_{r}, y_{r})$、$(x_{m}, y_{m})$。

如果$x_{r}-x_{l} \geq 4$，描迹形状为下降型。

如果$x_{l}-x_{r}\geq 4$，描迹形状为上升型。

如果$|x_{r}-x_{l}|<4$，同时$1/2(x_{r}+x_{l} )-x_{m}\geq4$时，描迹形状为中间凸起型。

如果$|x_{r}-x_{l} |<4$，同时$1/2(x_{r}+x_{l} )-x_{m}<4$时，描迹形状为直线型。

提取描迹的虚高和频率特征：对于上升型、下降型、直线型描迹，利用公式~\ref{式4_28}、~\ref{式4_30}计算描迹的 $f_{min}$、$f_{max}$。把描迹放入集合S中，利用公式~\ref{式4_27}可得${h^{'}}_{min}$。对于中间凸起型描迹，按最高点将描迹分割为两个描迹并分别获取两个描迹的描迹形状及 $f_{min}$、$f_{max}$、${h^{'}}_{min}$。
\begin{linenomath}
\begin{align}
f_{min} = f_{0} + y_{l}*f_{step}
\label{式4_28}
\end{align}
\end{linenomath}
\begin{linenomath}
\begin{align}
f_{max} = f_{0} + y_{r}*f_{step}
\label{式4_30}
\end{align}
\end{linenomath}  
 
\subsection{第三类E区电离图描迹特征提取}

第三类E区电离图是指 E 区只包含扩散性描迹 (Es 层 $a$型、$q$型、$s$型)。 第三类E区电离图判读算法流程如下:
首先，检测$s$型描迹，确定描迹区域闭合边界，找到边界中每一列的中点，对所有中点利用4次多项式进行拟合，确定拟合曲线的两个端点；利用两个端点位置做描迹区域的中线，并计算中线的斜率；如果斜率大于 0.15，就认为该描迹为$s$型描迹；
其次，根据描迹区域的长度$l_{area}$，对$a$型和$q$型描迹进行区分，如果$l_{area} < 100$，区域内描迹为$a$型；否则，描迹为$q$型；
然后，获取$a$型和$q$型描迹区域的左端点、右端点、对应的频率值作为描迹的 $f_{min}$、$f_{max}$，把描迹区域的最低虚高作为该描迹的${h^{'}}_{min}$。

\subsection{第四类E区电离图描迹特征提取}

对分割后的直线型描迹与$s$型描迹直接进行描迹特征提取。根据描迹的左端点、右端点确定对应的频率值作为描迹的 $f_{min}$、$f_{max}$，同时描迹的最低非零行对应的虚高值，作为${h^{'}}_{min}$。

%=============================================================================================================
\section{描迹类型识别与度量}
\label{4_6}

通过对电离图E区上的每个描迹区域进行描迹分割、描迹特征提取，可以确定电离图E区上共有多少个常规型描迹及每个描迹特征（电离图采集时间、描迹形状、$f_{min}$、$f_{max}$、${h^{'}}_{min}$）。

首先，我们根据每个常规型描迹的描迹特征，结合电离图度量知识对每个描迹的类型进行识别，即判断描迹属于E层、E2层或Es层的某种类型; 对于扩散型描迹，在描迹分割和特征提取算法中已经得到描迹的类型及特征。然后，对电离图的F层描迹的最小频率进行自动度量。最后，根据电离图度量规则得到E区参数$foE$、$h^{'}E$、$h^{'}Es$、$foEs$、$fbEs$。如图~\ref{图4_15}所示为最终的参数度量结果。

\begin{figure}[!ht]
\centering
\includegraphics[width=0.7\textwidth]{图4_15}
\caption{度量结果}
\label{图4_15}
\end{figure}
      

%-------------------------------------------------------------------------------------------------------------
\section{本章小结}
\label{4_7}

本章考虑到电离图E区描迹的多样性，设计了电离图E区描迹自动判读算法。算法主要包括：基于密集点检查提出了描迹区域查找算法；对于检测到的描迹区域根据扩散程度对区域进行分类；根据描迹区域的特征和分类结果对电离图进行分类，并排除非常规电离图；对于每类电离图根据电离图特征、运用图像处理及曲线拟合等技术分别设计了描迹分割、去除Es层多次反射、描迹特征提取算法；根据度量规则获取电离图E区描迹的相关参数。


















